name: Generate bestcf
on:
  workflow_dispatch:
  schedule:
    - cron: "0 */12 * * *"
  push:
    branches: [main]
    paths-ignore: ["**/README.md"]

jobs:
  build:
    runs-on: self-hosted
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: pip install requests

      - name: Generate bestcf `Domain`
        # 使用 Windows 自带的 powershell 避开 pwsh 缺失报错
        shell: powershell
        run: |
          $ProgressPreference = 'SilentlyContinue'
          if (!(Test-Path "./tmp")) { New-Item -ItemType Directory -Path "./tmp" }
          if (!(Test-Path "./bestcf")) { New-Item -ItemType Directory -Path "./bestcf" }
          
          # 抓取并利用 bash 处理文本，注意 PowerShell 中 $ 符号的转义
          (Invoke-WebRequest "https://cf.090227.xyz" -TimeoutSec 30).Content | bash -c "grep 'copyDomain' | awk -F \"'\" '{print \$2}'" > ./tmp/temp-bestcf-domain.txt
          (Invoke-WebRequest "https://cf.090227.xyz" -TimeoutSec 30).Content | bash -c "sed -n '/<pre>/,/<\/pre>/p' | sed 's/<pre>//; s/<\/pre>//; s/^[ \t]*//; s/#.*//'" >> ./tmp/temp-bestcf-domain.txt
          (Invoke-WebRequest "https://vps789.com/openApi/cfIpTop20" -TimeoutSec 30).Content | bash -c "jq -r '.data.good[].ip' | grep -Ev '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$'" >> ./tmp/temp-bestcf-domain.txt
          (Invoke-WebRequest "https://www.wetest.vip/page/cloudflare/cname.html" -TimeoutSec 30).Content | bash -c "awk '/4&amp;6/{print prev} {prev=\$0}' | awk -F '[<>]' '{print \$3}' | sed 's/\*/bestcf/'" >> ./tmp/temp-bestcf-domain.txt
          
          Get-Content ./tmp/temp-bestcf-domain.txt | bash -c "grep -E 'cloudflare|cf' | /usr/bin/sort -f -u" > ./bestcf/bestcf-domain.txt
          Remove-Item -Recurse -Force ./tmp

      - name: Generate bestcf `IP`
        shell: powershell
        run: |
          $ProgressPreference = 'SilentlyContinue'
          # 使用 Invoke-WebRequest 绕过 Schannel SSL 错误 (0x80090326)
          function Fetch-IP($url) { try { return (Invoke-WebRequest -Uri $url -TimeoutSec 30 -UseBasicParsing).Content } catch { return "" } }

          # CMCC-IP
          (Fetch-IP "https://cf.090227.xyz/cmcc?ips=50") | bash -c "sed 's/#.*//' | awk '{print \$0 \"#CMCC-IPv4_CMLiu_\" NR}'" > ./bestcf/cmcc-ip.txt
          (Fetch-IP "https://cf.090227.xyz/cmcc-ipv6?ips=50") | bash -c "sed 's/#.*//' | awk '{print \$0 \"#CMCC-IPv6_CMLiu_\" NR}'" >> ./bestcf/cmcc-ip.txt
          (Fetch-IP "https://vps789.com/openApi/cfIpApi") | bash -c "jq -r '.data.CM[].ip' | awk '{print \$0 \"#CMCC-IPv4_VPS789_\" NR}'" >> ./bestcf/cmcc-ip.txt
          
          # CUCC-IP
          (Fetch-IP "https://cf.090227.xyz/cu?ips=50") | bash -c "sed 's/#.*//' | awk '{print \$0 \"#CUCC-IPv4_CMLiu_\" NR}'" > ./bestcf/cucc-ip.txt
          (Fetch-IP "https://vps789.com/openApi/cfIpApi") | bash -c "jq -r '.data.CU[].ip' | awk '{print \$0 \"#CUCC-IPv4_VPS789_\" NR}'" >> ./bestcf/cucc-ip.txt
          
          # CTCC-IP
          (Fetch-IP "https://cf.090227.xyz/ct?ips=50") | bash -c "sed 's/#.*//' | awk '{print \$0 \"#CTCC-IPv4_CMLiu_\" NR}'" > ./bestcf/ctcc-ip.txt
          (Fetch-IP "https://vps789.com/openApi/cfIpApi") | bash -c "jq -r '.data.CT[].ip' | awk '{print \$0 \"#CTCC-IPv4_VPS789_\" NR}'" >> ./bestcf/ctcc-ip.txt

          # CF-IP
          (Fetch-IP "https://vps789.com/openApi/cfIpApi") | bash -c "jq -r '.data.AllAvg[].ip' | awk '{print \$0 \"#CF-IPv4_VPS789_\" NR}'" > ./bestcf/bestcf-ip.txt
          (Fetch-IP "https://ipdb.api.030101.xyz/?type=bestproxy") | bash -c "head -n 10 | awk '{print \$0 \"#Proxy-IPv4_IPDB_\" NR}'" > ./bestcf/proxy-ip.txt

      - name: Auto-Country Classification
        env:
          PYTHONIOENCODING: utf-8
        run: python filter.py

      - name: Git push
        shell: bash
        run: |
          cd ./bestcf/ || exit 1
          git init
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b bestcf
          git add .
          git commit -m "优选更新于 $(date +%Y-%m-%d)"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f origin bestcf
